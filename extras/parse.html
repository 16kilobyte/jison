<html>
  <head>
    <title>Jison, JavaScript Bottom-up Parser</title>
    
    <script>
      if(typeof console === 'undefined'){
      console = {};
      console.log = function(str){document.getElementById("out").value = uneval(str)};
    }
    var out = function(str){document.getElementById("out").value = uneval(str)};
    </script>
    <script src="http://www.json.org/json2.js"></script>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.3.2/jquery.min.js"></script>
    <script src="es.js"></script>
    <script src="../lib/jison/lex.js"></script>
    <script src="../lib/jison/util/typal.js"></script>
    <script src="../lib/jison/util/set.js"></script>
    <script src="../lib/jison.js"></script>
    <script>

      var parser;
      $(function(){

        $(".state").live("click", function (ev){
          var split = this.id.split("_");
          var state = parser.states.item(split[1]);
          $(this).children(".details").toggleClass("open")
            .html(state.join('<br />'))
            .append("<br/>");
        });

        $(".action").live("click", function (ev){
          var split = this.id.split("-");
          var table = parser.table[split[1]];
          var actions = table[split[2]];
          var details = $(this).children(".details");
          details.html("").addClass("open");
          for (var i in actions) {
            if (actions[i][0] == 's') {
              var link = "<a href='#state_"+actions[i][1]+"'>Go to state "+actions[i][1]+"</a>";
              details.append("- Shift "+split[2]+" then "+link).append("<br />");
            }
            else if (actions[i][0] == 'r') {
              var text = "- Reduce by "+actions[i][1]+") "+parser.productions[actions[i][1]];
              details.append(text).append("<br />");
            }
          }
        });

        $(".details").live("click", function (ev){
          $(this).html("").removeClass("open");
          if(!$(ev.target).is("a"))
            return false;
        });
      });
      function processGrammer() {
        var type = document.getElementById("type").options[document.getElementById("type").selectedIndex].value || "lalr";
        var cfg = JSON.parse(document.getElementById("grammer").value);
        parser = new Jison.Parser(cfg, {type: type,noDefaultResolve:true});
        document.getElementById("out").value = '';
        nonterminalInfo(parser);
        productions(parser);
        if(type === 'll')
          llTable(parser);
        else {
          lrTable(parser);
        }
      }

      function runParser() {
        var source = document.getElementById("source").value;
        out(parser.parse(source));
      }

      function nonterminalInfo(p){
        var out = ["Non-terminals"];
        for(var nt in p.nonterminals){
          out.push(nt+"\n\tnullable: "+(p.nonterminals[nt].nullable ? 'Yes':'No')+"\n\tfirsts: "+p.nonterminals[nt].first+"\n\tfollows: "+p.nonterminals[nt].follows);
          out.push("\t"+p.nonterminals[nt].productions.join("\n\t"));
        }
        document.getElementById("out").value += out.join("\n\n");
      }

      function productions(p){
        var out = ['<ol start="0">','<li>'];
        out.push(p.productions.join('</li><li>'));
        out.push('</li>','</ol>');
      document.getElementById("productions").innerHTML = "<h2>Productions</h2>"+out.join("");
      }


      function llTable(p){
        var out = ['<table border="1">','<tr>'];
        out.push('<td>','</td>');
        p.terminals.forEach(function(t){
          out.push('<td>',t,'</td>');
        });
        out.push('</tr>');

        for(var nt in  p.table){
          out.push('<tr><td>',nt,'</td>');
          p.terminals.forEach(function(t){
            var cell = p.table[nt][t];
            if(cell)
              out.push((cell.length>1?'<td class="conflict">':'<td>'),cell.toString(),'</td>');
            else
              out.push('<td>&nbsp;</td>');
          });
          out.push('</tr>');
        }

        out.push('</table>');
        document.getElementById("table").innerHTML = "<h2>Parse Table</h2>"+out.join("");
      }

      function printAction(a){
        if(!a[0]) return '';
        var str = [];
        for(var i=0;i<a.length;i++)
          str.push(a[i].join(''));
        return str.join(', ');
      }
      function lrTable(p){
        var gs = p.symbols.slice(0).sort();
        var out = ['<table border="1">','<thead>','<tr>'];
        out.push('<th>','</th>');
        var ntout = [];
        gs.shift();
        gs.forEach(function(t){
          if(p.nonterminals[t])
          ntout.push('<th class="nonterm nt-'+t+'"">',t,'</th>');
          else
            out.push('<th>',t,'</th>');
        });
        out.push.apply(out, ntout);
        out.push('</tr>','</thead>');

        for(var i=0,state;state=p.table[i];i++){
          ntout = [];
          out.push('<tr><td class="state" id="state_'+i+'">',i,'<div class="details"></div></td>');
          gs.forEach(function(t){
            if(state[t]){
              if(p.nonterminals[t])
                ntout.push('<td class="nonterm nt-'+t+'"><a href="#state_'+state[t]+'">',state[t],'</a></td>');
              else
              out.push('<td id="act-'+i+'-'+t+'" class="action">',printAction(state[t]),'<div class="details"></div></td>');
            }else
            out.push('<td>&nbsp;</td>');
          });
          out.push.apply(out, ntout);
          out.push('</tr>');
        }

        out.push('</table>');

        document.getElementById("table").innerHTML = "<h2>Parse Table</h2>"+out.join("");

        p.resolutions.forEach(function (res){
          var r = res[2];
          var el = document.getElementById('act-'+res[0]+'-'+res[1]);
          if (r.bydefault) {
            el.className += ' conflict';
          }
          if(el)
            el.title += r.msg+"\n"+"("+r.s+", "+r.r+") -> "+r.action;
        });

      }
    </script>
    <style>
      #table, #productions {
        display: inline;
        font-family: monospace;
      }
      .nonterm {
        background-color: #eef;
      }
      .conflict {
        background-color: #ffa;
      }
      .action, .state {
        cursor: pointer;
      }
      .action:hover {
      }
      .details {
        background-color: #f0f0f0;
        font-size: 90%;
      }
      .details.open {
        white-space:nowrap;
      }
    </style>

  </head>

  <body>
    <h1>Jison</h1>
    <p>Input a grammer, along with token list and start symbol, in <a href="http://json.org/">JSON</a> format. Example below.</p>
    <textarea id="grammer" rows="20" cols="80">
{
    "lex": {
        "macros": {
            "digit": "[0-9]",
            "id": "[a-zA-Z][a-zA-Z0-9]*" 
        },

        "rules": [
            ["//.*",       "/* ignore comment */"],
            ["main\\b",     "return 'MAIN';"],
            ["class\\b",    "return 'CLASS';"],
            ["extends\\b",  "return 'EXTENDS';"],
            ["nat\\b",      "return 'NATTYPE';"],
            ["if\\b",       "return 'IF';"],
            ["else\\b",     "return 'ELSE';"],
            ["for\\b",      "return 'FOR';"],
            ["printNat\\b", "return 'PRINTNAT';"],
            ["readNat\\b",  "return 'READNAT';"],
            ["this\\b",     "return 'THIS';"],
            ["new\\b",      "return 'NEW';"],
            ["var\\b",      "return 'VAR';"],
            ["null\\b",     "return 'NUL';"],
            ["{digit}+",   "return 'NATLITERAL';"],
            ["{id}",       "return 'ID';"],
            ["==",         "return 'EQUALITY';"],
            ["=",          "return 'ASSIGN';"],
            ["\\+",        "return 'PLUS';"],
            ["-",          "return 'MINUS';"],
            ["\\*",        "return 'TIMES';"],
            [">",          "return 'GREATER';"],
            ["\\|\\|",     "return 'OR';"],
            ["!",          "return 'NOT';"],
            ["\\.",        "return 'DOT';"],
            ["\\{",        "return 'LBRACE';"],
            ["\\}",        "return 'RBRACE';"],
            ["\\(",        "return 'LPAREN';"],
            ["\\)",        "return 'RPAREN';"],
            [";",          "return 'SEMICOLON';"],
            ["\\s+",       "/* skip whitespace */"],
            [".",          "print('Illegal character');throw 'Illegal character';"],
            ["$",          "return 'ENDOFFILE';"]
        ]
    },

    "tokens": "MAIN CLASS EXTENDS NATTYPE IF ELSE FOR PRINTNAT READNAT THIS NEW VAR NUL NATLITERAL ID ASSIGN PLUS MINUS TIMES EQUALITY GREATER OR NOT DOT SEMICOLON LBRACE RBRACE LPAREN RPAREN ENDOFFILE",
    "operators": [
        ["right", "ASSIGN"],
        ["left", "OR"],
        ["nonassoc", "EQUALITY", "GREATER"],
        ["left", "PLUS", "MINUS"],
        ["left", "TIMES"],
        ["right", "NOT"],
        ["left", "DOT"]
    ],

    "bnf": {
        "pgm": ["cdl MAIN LBRACE vdl el RBRACE ENDOFFILE"],

        "cdl": ["c cdl",
                ""],

        "c": ["CLASS id EXTENDS id LBRACE vdl mdl RBRACE"],

        "vdl": ["VAR t id SEMICOLON vdl",
                ""],

        "mdl": ["t id LPAREN t id RPAREN LBRACE vdl el RBRACE mdl",
                ""],

        "t": ["NATTYPE",
              "id"],

        "id": ["ID"],

        "el": ["e SEMICOLON el",
               "e SEMICOLON"],

        "e": ["NATLITERAL",
              "NUL",
              "id",
              "NEW id",
              "THIS", 
              "IF LPAREN e RPAREN LBRACE el RBRACE ELSE LBRACE el RBRACE ",
              "FOR LPAREN e SEMICOLON e SEMICOLON e RPAREN LBRACE el RBRACE",
              "READNAT LPAREN RPAREN",
              "PRINTNAT LPAREN e RPAREN",
              "e PLUS e",
              "e MINUS e",
              "e TIMES e",
              "e EQUALITY e",
              "e GREATER e",
              "NOT e",
              "e OR e",
              "e DOT id",
              "id ASSIGN e",
              "e DOT id ASSIGN e",
              "id LPAREN e RPAREN",
              "e DOT id LPAREN e RPAREN",
              "LPAREN e RPAREN"]
    }
}
    </textarea><br/>
    <select id="type">
      <option value="lr0">LR(0)</option>
      <option value="slr" selected="true">SLR(1)</option>
      <option value="lalr">LALR(1)</option>
      <option value="lr">LR(1)</option>
      <option value="ll">LL(1)</option>
    </select>
    <button onclick="processGrammer()">Process CFG</button><br/>
    <p>source</p>
    <textarea id="source" rows="6" cols="80"></textarea><br/>
    <button onclick="runParser()">Parse source</button>
    <h2>Output</h2>
    <textarea id="out" readonly="true" rows="20" cols="80"/></textarea>
    <div id="productions"></div>
    <div id="table"></div>
    <p><small><em>By Zach Carter (zcarter@mail.usf.edu)</em></small></p>
  </body>
</head>
