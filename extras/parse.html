<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />

    <title>Jison, parse table visualation page</title>
    
    <script>
      if(typeof console === 'undefined'){
      console = {};
      console.log = function(str){document.getElementById("out").value = uneval(str)};
    }
    var printOut = function(str){document.getElementById("out").value = JSON.stringify(str)};
    </script>
    <script src="json2.js"></script>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.3.2/jquery.min.js"></script>
    <script src="es.js"></script>
    <script src="../lib/jison/lex.js"></script>
    <script src="../lib/jison/util/typal.js"></script>
    <script src="../lib/jison/util/set.js"></script>
    <script src="../lib/jison.js"></script>
    <script>
      var parser;
      $(function(){

        $(".action, .state").live("click", function (ev){
          if(!$(ev.target).is("a"))
            $(this).toggleClass("open");
        });
        $(".action, .state").live("dblclick", function (ev){
            var row = this.className.match(/(row_[0-9]+)/)[1];
            $(this).hasClass("open") ?
              $("."+row).removeClass("open") :
              $("."+row).addClass("open");
            return false;
        });

        $("#examples").change(function(ev) {
          var file = this.options[this.selectedIndex].value;
          $(document.body).addClass("loading");
          $.get("../examples/"+file+".json", function (data) {
            $("#grammar").val(data);
            $(document.body).removeClass("loading");
          });
        });

      });
      function processGrammar() {
        var type = document.getElementById("type").options[document.getElementById("type").selectedIndex].value || "slr";

        try{
        var cfg = JSON.parse($("#grammar").val());
        }catch(e){ return alert("Oops. Make sure your JSON is correct.\n"+e); }

        if(cfg.lex) $("#parsing").show();
        else $("#parsing").hide();

        parser = new Jison.Parser(cfg, {type: type,noDefaultResolve:true});
        if (parser.computeLookAheads)
          parser.computeLookAheads();

        $("#out").val('');
        nonterminalInfo(parser);
        productions(parser);
        if(type === 'll')
          llTable(parser);
        else {
          lrTable(parser);
        }
      }

      function runParser() {
        if(!parser) processGrammer();
        printOut("Parsing...");
        var source = $("#source").val();
        try{
          printOut(parser.parse(source));
        }catch(e){
          printOut(e.message || e);
        }
      }

      function nonterminalInfo(p){
        var out = ["<h3>Non-terminals</h3><dl>"];
        for(var nt in p.nonterminals){
          out.push("<dt>",nt,"</dt>");
          out.push("<dd>", "nullable: "+(p.nonterminals[nt].nullable ? 'Yes':'No')+"<br/>firsts: "+p.nonterminals[nt].first+"<br/>follows: "+p.nonterminals[nt].follows);
          out.push("<p>Productions: ");
          p.nonterminals[nt].productions.forEach(function (prod) {
            out.push('<a href="#prod_'+prod.id+'">'+prod.id+'</a>');
          });
          out.push("</p></dd>");
        }
        out.push("</dl>");
        $("#nonterminals").html(out.join("\n"));
      }

      function productions(p){
        var out = ['<ol start="0">'];
          p.productions.forEach(function (prod) {
            out.push("<li id='prod_"+prod.id+"'>", prod, "</li>");
          });
        out.push('</ol>');
        document.getElementById("productions").innerHTML = "<h3>Productions</h3>"+out.join("");
      }


      function printCell(cell){
        var out = cell.join(",");

        out += "<div class='details'>";
        for(var i=0;i<cell.length;i++)
          out += parser.productions[cell[i]]+"<br />"; 
        out += "</div>";

        return out;
      }
      function llTable(p){
        var out = ['<table border="1">','<tr>'];
        out.push('<td>','</td>');
        p.terminals.forEach(function(t){
          out.push('<td>',t,'</td>');
        });
        out.push('</tr>');

        for(var nt in  p.table){
          out.push('<tr><td>',nt,'</td>');
          p.terminals.forEach(function(t){
            var cell = p.table[nt][t];
            if(cell)
              out.push('<td id="cell_'+nt+'_'+t+'" class="cell_'+nt+' '+(cell.length>1? 'conflict':'')+' action">',printCell(cell),'</td>');
            else
              out.push('<td>&nbsp;</td>');
          });
          out.push('</tr>');
        }

        out.push('</table>');
        document.getElementById("table").innerHTML = "<h3>LL(1) Parse Table</h3>"+out.join("");
      }

      function printActionDetails(a, token) {
          var out = "<div class='details'>";

          for (var i=0;i<a.length;i++) {
            if (a[i][0] == 's') {
              var link = "<a href='#state_"+a[i][1]+"'>Go to state "+a[i][1]+"</a>";
              out += "- Shift "+token+" then "+link+"<br />";
            }
            else if (a[i][0] == 'r') {
              var text = "- Reduce by "+a[i][1]+") "+parser.productions[a[i][1]];
              out += text+"<br />";
            }
          }
          return out+"</div>";
      }
      function printAction(a){
          if(!a[0]) return '';
          var out = '',
              ary = [];

          for(var i=0;i<a.length;i++)
            ary.push('<span class="action_'+(a[i][0])+'">'+a[i].join('')+'</span>');

          out += ary.join(',');

          return out;
      }
      function lrTable(p){
        var gs = p.symbols.slice(0).sort();
        var out = ['<table border="1">','<thead>','<tr>'];
        out.push('<th>&#8595;states','</th>');
        var ntout = [];
        gs.shift();
        gs.forEach(function(t){
          if(p.nonterminals[t])
          ntout.push('<th class="nonterm nt-'+t+'"">',t,'</th>');
          else
            out.push('<th>',t,'</th>');
        });
        out.push.apply(out, ntout);
        out.push('</tr>','</thead>');

        for(var i=0,state;i < p.table.length;i++){
          state=p.table[i];
          if (!state) continue;
          ntout = [];
          out.push('<tr><td class="row_'+i+' state" id="state_'+i+'">',i,'<div class="details">'+parser.states.item(i).join('<br />')+'</div></td>');
          gs.forEach(function(t){
            if(p.nonterminals[t]){
              if(typeof state[t] === 'number')
                ntout.push('<td class="nonterm nt-'+t+'"><a href="#state_'+state[t]+'">',state[t],'</a></td>');
              else 
                ntout.push('<td class="nonterm">&nbsp;</td>');
            } else if (state[t])
              out.push('<td id="act-'+i+'-'+t+'" class="row_'+i+' '+(state[t][0] == 'a' ? "accept" : '')+' action">',printAction(state[t]),printActionDetails(state[t], t));
            else
              out.push('<td>&nbsp;</td>');
          });
          out.push.apply(out, ntout);
          out.push('</tr>');
        }

        out.push('</table>');

      $("#table").html("<h3>"+parser.type+" Parse Table</h3><p>Click cells to show details</p>"+out.join(""));

        p.resolutions.forEach(function (res){
          var r = res[2];
          var el = document.getElementById('act-'+res[0]+'-'+res[1]);
          if (r.bydefault) {
            el.className += ' conflict';
          }
          if(el)
            el.title += r.msg+"\n"+"("+r.s+", "+r.r+") -> "+r.action;
        });

      }
    </script>
    <style>
      body {
        font-family: Georgia, serif;
        color: #222;
      }
      a img { border: 0px; }
      #table table, #productions li, #nonterminals dl {
        font-family: monospace;
      }
      #usf_logo {
        position: absolute;
        top: 10px;
        right: 10px;
      }
      #loading {
        position: fixed;
        top: 0px;
        right: 100px;
        z-index: 10;
        width: 16px;
        height: 16px;
      }
      #parsing {
        display: none;
      }
      #nonterminals dl {
        font-size: 90%;
      }
      body.loading #loading {
        background: url(spin.gif) no-repeat;
      }
      h1 {
        font-size: 2.8em;
      }
      h2 {
        font-size: 2.2em;
      }
      h3 {
        font-size: 1.8em;
      }
      dt { font-weight: bold; }

      .nonterm { background-color: #eef; }
      .action_s { color: #940; }
      .action_r { color: #707; }
      .accept { background-color: #dfd !important; }
      .conflict { background-color: #ffa !important; }
      .action, .state, .llaction {
        cursor: pointer;
      }
      .action:hover {
      }
      .open .details{
        white-space:nowrap;
        display: block;
      }
      .details {
        background-color: #eee;
        font-size: 90%;
        display: none;
      }
      .details.open {
        white-space:nowrap;
      }
      button, select {
      }
      table tr:hover td {
        background-color: #eee;
      }
      #table table {
        border: 1px #6699CC solid;
        border-collapse: collapse;
        border-spacing: 0px;
      }
      #table table tr td, #table table th { padding: 3px; }
    </style>

  </head>

  <body>

    <h1>Jison</h1>

    <div id="intro">
      <p><em>By Zach Carter (zcarter@mail.usf.edu)</em><br />
      Special thanks to <a href="http://www.cse.usf.edu/~ligatti/">Dr. Ligatti</a> for suggesting and giving feedback on the interface.<br />
      <a href="http://www.cse.usf.edu" id="usf_logo"><img src="usf.jpg" alt="USF" /></a>
      </p>
      <p>This page can be used to display parse tables and other useful information about your CFG. Currently doesn't work in IE.</p>
    </div>

    <h2>Input</h2>

    <p>Input a <a href="http://en.wikipedia.org/wiki/Backus%E2%80%93Naur_Form">BNF</a> grammar along with a token list and optional start symbol, in <a href="http://json.org/">JSON</a> format. 
    </p>
    <p>
    Load an example:
    <select id="examples">
      <option value="basic" selected="true">Basic</option>
      <option value="basic_lex">Basic w/ lex</option>
      <option value="basic2">Basic #2</option>
      <option value="basic2_lex">Basic #2 w/ lex</option>
      <option value="reduce_conflict">Reduce conflict</option>
      <option value="dism">DISM</option>
      <option value="dism_lr0">DISM in LR(0)</option>
      <option value="precedence">Advanced</option>
    </select>
    </p>

    <textarea id="grammar" rows="20" cols="80">
{
    "tokens": "ZERO PLUS",
    "bnf": {
        "E" :[ "E PLUS T",
               "T" ],
        "T" :[ "ZERO" ]
    }
}
</textarea>

    <p>
      <select id="type">
        <option value="lr0">LR(0)</option>
        <option value="slr" selected="true">SLR(1)</option>
        <option value="lalr">LALR(1)</option>
        <option value="lr">LR(1)</option>
        <option value="ll">LL(1)</option>
      </select>
      <small>* WARNING: LR(1) and LALR(1) take considerable time to execute for large/ambigous grammars.</small>
      </p>
      <p><button onclick="processGrammar()">Process Grammar</button>
    </p>


    <h2>Output</h2>
    <div id="nonterminals">Process your grammar to see the result.</div>
    <div id="productions"></div>
    <div id="table"></div>


    <div id="parsing">
      <h2>Parse a program</h2>
      <p>Grammars with lexing information allow for parsing. Use the form below to parse a program using your grammar.</p>
      <textarea id="source" rows="8" cols="80"></textarea><br/>
      <button onclick="runParser()">Parse source</button>
      <h3>Result</h3>
      <textarea id="out" readonly="true" rows="5" cols="80"/></textarea>
    </div>

    <div id="loading"></div>
    <p>
      <small><i>Zach Carter (zcarter@mail.usf.edu) 2009</i><small>
    </p>
  </body>
</head>
